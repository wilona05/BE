import sqlite3 from"sqlite3";import{open}from"sqlite";import path from"node:path";import{fileURLToPath}from"node:url";import{Readable}from"node:stream";const __filename=fileURLToPath(import.meta.url),__dirname=path.dirname(__filename),dbPromise=open({filename:path.join(process.cwd(),"mydb.sqlite"),driver:sqlite3.Database});function parseBody(e){return new Promise((a=>{let t="";e.on("data",(e=>t+=e.toString())),e.on("end",(()=>{const e=new URLSearchParams(t);a(Object.fromEntries(e))}))}))}function parseBodyJSON(e){return new Promise(((a,t)=>{let r="";e.on("data",(e=>{r+=e.toString()})),e.on("end",(()=>{try{a(JSON.parse(r))}catch(e){t(e)}}))}))}export async function createReservation(e,a){try{const t=await parseBody(e),{namaInput:r,telpInput:n,paxInput:i,idMeja:s}=t,o=await dbPromise,m=e.headers.cookie||"",d=Object.fromEntries(m.split("; ").map((e=>e.split("=")))).id_user;if(!d)return a.writeHead(401,{"Content-Type":"text/plain"}),a.end("Anda harus login terlebih dahulu.");const u=(new Date).toISOString().slice(0,10),l=await o.get("SELECT id_meja FROM meja WHERE no_meja = ?",[s]);if(!l)return a.writeHead(400,{"Content-Type":"text/plain"}),a.end("Meja tidak ditemukan");const c=l.id_meja;return await o.run("INSERT INTO reservasi (id_user, date, id_meja, jmlh_org, kontak, status)\n             VALUES (?, ?, ?, ?, ?, ?)",[d,u,c,i,n,"aktif"]),a.writeHead(302,{Location:"/homepage_user"}),a.end()}catch(e){return console.error(e),a.writeHead(500,{"Content-Type":"text/plain"}),a.end("Terjadi kesalahan saat membuat reservasi")}}export async function getUserActiveReservation(e){const a=await dbPromise,t=(new Date).toISOString().slice(0,10);return a.get("\n        SELECT r.id_reservasi, m.no_meja, r.jmlh_org, r.kontak \n        FROM reservasi r\n        JOIN meja m ON r.id_meja = m.id_meja\n        WHERE r.id_user = ? \n            AND r.date = ?\n            AND r.status = 'aktif'\n        LIMIT 1\n    ",[e,t])}export async function getAllMeja(){const e=await dbPromise,a=(new Date).toISOString().slice(0,10);return e.all("\n        SELECT \n            m.id_meja,\n            m.no_meja,\n            CASE \n                WHEN EXISTS (\n                    SELECT 1 \n                    FROM reservasi r\n                    WHERE r.id_meja = m.id_meja\n                    AND r.date = ?\n                    AND r.status = 'aktif'\n                )\n                THEN 0\n                ELSE 1\n            END AS available\n        FROM meja m\n        ORDER BY m.no_meja\n    ",[a])}export async function batalkanReservasi(e,a,t){const r=await parseBodyJSON(e),{id_reservasi:n}=r,i=await dbPromise;(new Date).toISOString().slice(0,10);try{await i.run("UPDATE reservasi \n            SET status = 'batal' \n            WHERE id_reservasi = ? \n            AND id_user = ?",[n,t]),a.writeHead(200,{"Content-Type":"application/json"});Readable.from(JSON.stringify({success:!0})).pipe(a)}catch(e){return console.error(e),a.writeHead(500,{"Content-Type":"text/plain"}),a.end("Terjadi kesalahan saat membatalkan reservasi")}}export async function getAllReservations(){return(await dbPromise).all("SELECT * FROM users u INNER JOIN reservasi r ON u.id_user = r.id_user INNER JOIN meja m on r.id_meja = m.id_meja;")}export async function getTotalReservasi(){return(await dbPromise).get("SELECT COUNT(*) AS totalReservasi FROM reservasi;")}export async function getReservasiAktif(){return(await dbPromise).get("SELECT COUNT(*) AS reservasiAktif FROM reservasi WHERE status=='aktif';")}export async function getReservasiSelesai(){return(await dbPromise).get("SELECT COUNT(*) AS reservasiSelesai FROM reservasi WHERE status=='selesai';")}export async function getReservasiDibatalkan(){return(await dbPromise).get("SELECT COUNT(*) AS reservasiDibatalkan FROM reservasi WHERE status=='batal';")}export async function getJmlhPemesan(){return(await dbPromise).get("SELECT COUNT(DISTINCT u.id_user) AS jmlhPemesan FROM users u inner join reservasi r on u.id_user = r.id_user;")}export async function editStatus(e,a){return(await dbPromise).run("UPDATE reservasi SET status = ? WHERE id_reservasi = ?;",[a,e])}