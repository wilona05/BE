import sqlite3 from"sqlite3";import{open}from"sqlite";import path from"node:path";import{fileURLToPath}from"node:url";import*as bcrypt from"bcrypt";import zlib from"node:zlib";const __filename=fileURLToPath(import.meta.url),__dirname=path.dirname(__filename),dbPromise=open({filename:path.join(process.cwd(),"mydb.sqlite"),driver:sqlite3.Database});function parseBody(e){return new Promise((a=>{let t="";e.on("data",(e=>t+=e.toString())),e.on("end",(()=>{const e=new URLSearchParams(t);a(Object.fromEntries(e))}))}))}function streamCompressed(e,a,t){e.writeHead(a,{"Content-Type":"text/plain","Content-Encoding":"gzip"});const o=zlib.createGzip();o.pipe(e),o.end(t)}export async function loginUser(e,a){const t=await parseBody(e),{email:o,password:r}=t,i=await dbPromise,n=await i.get("SELECT * FROM users WHERE email = ?",[o]);if(!n)return streamCompressed(a,401,"Email atau password salah");const s=r,m=n.password;try{return await bcrypt.compare(s,m)?(console.log(`Login BERHASIL untuk ${o}!`),"admin"===n.role?a.writeHead(302,{"Set-Cookie":[`id_user=${n.id_user}; HttpOnly; Path=/`,`role=${n.role}; HttpOnly; Path=/`],Location:"/homepage_admin"}):a.writeHead(302,{"Set-Cookie":[`id_user=${n.id_user}; HttpOnly; Path=/`,`role=${n.role}; HttpOnly; Path=/`],Location:"/homepage_user"}),a.end()):(console.log(`Login GAGAL untuk ${o}: Password tidak cocok.`),streamCompressed(a,401,"Email atau password salah"))}catch(e){console.error("Kesalahan saat membandingkan hash (Internal Error):",e),streamCompressed(a,500,"Terjadi kesalahan server saat memproses login.")}}